#!/bin/bash
# Author: PietroVN
# Deps: mpv, youtube-dl(or any fork), search (included), curl, sed
# Examples:
# video anime list					| List anime and give some useful options
# video anime <anime name>			| Search for anime with this name
# video youtube <video name>		| Search for a video with this name
# video url <url>					| Play specified url

# Include search
. /usr/local/bin/search

# Command
command=$@

# Enviroment
root="${HOME}/video_cli"

# Anime related
anime_root="${root}/animes/"
tmp_anime_list="${XDG_RUNTIME_DIR}/tmp_local_anime_list.txt"

_youtube() {
	# Leave only the title on command
	command=$(sed 's/youtube//g' <<< ${command})

	# Search
	search _youtube:${command}

	# Check for errors | don't warn the user about the error because search already handle this
	[[ -f "${tmp_videos}" ]] || exit

	# Video selection
	echo "Select video:"
	read video_number

	# Get video from tmp videos
	video=$(cat ${tmp_videos} | sed -n ${video_number}p)

	# Play
	mpv --no-terminal ${youtube}${video}
}

_set_anime_variables() {
	anime_current=$(cat ${tmp_selected_anime_dir})

	# Set folders
	anime_folder="${anime_root}${anime_current}/"
	anime_current_episode_dir="${anime_folder}/current_episode.txt"
	anime_current_watching_dir="${anime_folder}/current_watching.txt"
	anime_episodes_dir="${anime_folder}/episodes.txt"

	# Set some variables that depend on files
	[[ -f ${anime_current_episode_dir} ]] && anime_current_episode=$(cat ${anime_current_episode_dir})
	[[ -f ${anime_episodes_dir} ]] && anime_episodes=$(cat ${anime_episodes_dir})
	anime_current_watching=${anime_current}
}

_anime_list() {
	number=1

	# Delete previous anime list
	[[ -d ${tmp_anime_list} ]] && rm ${tmp_anime_list}

	# Store | List
	for f in ${anime_root}*; do
		echo "$(basename ${f})" > ${tmp_anime_list}
		echo "${number} - $(basename ${f})"
		number=$((${number}+1))
	done

	# Read user choice
	echo ""
	echo "Choose an anime:"
	read choosen_anime

	# Enter anime screen
	echo "Anime: $(cat ${tmp_anime_list} | sed -n ${choosen_anime}p)"
	echo "[1] - Watch current episode"
	echo "[2] - Watch next episode"
	echo "[3] - Watch previous episode"
	echo "[4] - Download all episodes"
	echo "[5] - Download selected episodes (soon)"
	echo "[q] - Quit"
	echo ""
	echo "Choosen an option:"

	# Read user choice
	read what_to_do

	case ${what_to_do} in 
		"1")
			# Current anime
			echo "$(cat ${tmp_anime_list} | sed -n ${choosen_anime}p)" > ${tmp_selected_anime_dir}

			# Watch mode
			watch="current"

			# Watch
			_anime_watch
		;;
		"2")
			# Current anime
			echo "$(cat ${tmp_anime_list} | sed -n ${choosen_anime}p)" > ${tmp_selected_anime_dir}

			# Watch mode
			watch="next"

			# Watch
			_anime_watch
		;;
		"3")
			# Current anime
			echo "$(cat ${tmp_anime_list} | sed -n ${choosen_anime}p)" > ${tmp_selected_anime_dir}

			# Watch mode
			watch="prev"

			# Watch
			_anime_watch
		;;
		"4")
		;;
		"q")
			exit 0
		;;
	esac
}

_anime_watch() {
	case ${watch} in
		"current")
			# Anime
			_set_anime_variables
			anime=$(cat ${anime_episodes_dir} | sed -n ${anime_current_episode}p)

			# informs the user
			echo "Playing: ${anime_current_watching}"
			echo "Episode: ${anime_current_episode}"

			echo ""
			echo "Opening mpv.."

			# play && falback
			mpv --no-terminal ${anime} &
		;;
		"next")
			# set current ep
			_set_anime_variables
			anime_episode="$((${anime_current_episode}+1))"
			echo "${anime_episode}" > ${anime_current_episode_dir}
			_set_anime_variables

			# get next eoisode
			anime=$(cat ${anime_episodes_dir} | sed -n ${anime_episode}p)

			# informs the user
			echo "Playing: ${anime_current_watching}"
			echo "Episode: ${anime_current_episode}"

			echo ""
			echo "Opening mpv.."

			# play && falback
			mpv --no-terminal ${anime} &
		;;
		"prev")
			# Set current ep
			_set_anime_variables
			anime_episode="$((${anime_current_episode}-1))"
			echo "${anime_episode}" > ${anime_current_episode_dir}
			_set_anime_variables

			# Get previous eoisode
			anime=$(cat ${anime_episodes_dir} | sed -n ${anime_episode}p)

			# Informs the user
			echo "Playing: ${anime_current_watching}"
			echo "Episode: ${anime_current_episode}"

			echo ""
			echo "Opening mpv.."

			# Play
			mpv --no-terminal ${anime} &
		;;
	esac
}

_anime_search() {
	# Leave only the title on command
	command=$(sed 's/anime//g' <<< ${command})

	########## Animes folder

	# Set some variables that depend on files
	_set_anime_variables

	# Setup a dir on user home
	[[ -d "${root}" ]] || mkdir ${root}

	# Create anime root
	[[ -d "${anime_root}" ]] || mkdir ${anime_root}

	# Create folder for saving current anime episode
	[[ -d "${anime_folder}" ]] || mkdir "${anime_folder}"

	# Search anime
	search _anime:${command}
	
	# Check for errors
	[[ -f "${tmp_animes_dir}" ]] || echo "Error fetching anime list"
	[[ -f "${tmp_animes_dir}" ]] || exit

	# Set some variables that depend on files
	_set_anime_variables

	########## QOL

	# Check if user watched this anime before and prompt to continue watching
	if [[ -f ${anime_current_episode_dir} ]]; then
		# Prompt user
		echo ""
		echo "You already watched this anime before, do you want to continue from where you stopped?"
		echo "[yes | no | next | prev]"
		read continue_

		# Continue
		[[ "${continue_}" == "yes" ]] && choosen_episode=${anime_current_episode}
		[[ "${continue_}" == "next" ]] && choosen_episode=$((${anime_current_episode}+1))
		[[ "${continue_}" == "prev" ]] && choosen_episode=$((${anime_current_episode}-1))
		[[ "${continue_}" == "no" ]] || echo "${choosen_episode}" > ${anime_current_episode_dir}

		# Set some variables that depend on files
		_set_anime_variables
	fi
	
	if [[ "${continue_}" == "no" || -z ${continue_} ]]; then
		# Fetch episodes list
		search _choose_anime_episode
		
		# Check for errors
		[[ -f "${tmp_animes_dir}" ]] || echo "Error fetching episodes list"
		[[ -f "${tmp_animes_dir}" ]] || exit

		# Delete previous episode list
		[[ -f ${anime_episodes_dir} ]] && rm ${anime_episodes_dir}

		# Dump episodes to animedir
		for f in $(cat ${tmp_animes_dir}); do
			echo "${f}" >> "${anime_episodes_dir}"
		done

		# Select episode
		echo "Select episode:"
		read choosen_episode

		# Set some variables that depend on files
		_set_anime_variables
	fi

	# Get episode
	video=$(cat ${anime_episodes_dir} | sed -n ${choosen_episode}p)

	# Save current episode
	echo "${choosen_episode}" > "${anime_current_episode_dir}"

	# Informs the user
	echo "Playing: ${anime_current}"
	echo "Episode: ${anime_current_episode}"

	# Update current_watching
	echo "${anime_current}" > ${anime_current_watching_dir}

	echo ""
	echo "Opening mpv..."

	# Play
	mpv --no-terminal ${video} &
}

_url() {
	# Clear command
	command=$(sed 's/url://g' <<< ${command})

	# Play
	mpv --no-terminal ${command}
}

# Check if command is empty
[[ -z ${command} ]] && echo "Empty command"

case ${command} in
	"anime list")
		_anime_list
	;;
	*"anime"*)
		_anime_search
	;;
	*"youtube"*)
		_youtube
	;;
	*"url"*)
		_url
	;;
	"next")
		_next
	;;
	"prev")
		_prev
	;;
	"previous")
		_prev
	;;
esac
